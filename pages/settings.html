<!DOCTYPE html>
<html>

<head>
    <title>Settings</title>

    {meta}
</head>

<body>
    {nav}

    <main>
        <h1>Settings</h1>

        <div id="settings-list"></div>
        <br>
        <button type="button" id="import">Import settings</button>
        <button type="button" id="export">Export settings</button>
        <input type="file" class="hidden" id="importFile">

        <script>
            if (window.settingsLoaded) {
                next()
            } else {
                window.addEventListener("settingsLoaded", next)
            }

            function next() {
                settings.forEach(setting => {
                    if (!setting.handler.display()) {
                        return
                    }

                    var settingObject = document.createElement("div")
                    settingObject.id = "setting-" + setting.id
                    settingObject.innerHTML = '<label for="setting-' + setting.id + '-label">' + setting.title + ": </label>"

                    var valueObject = document.createElement("input")
                    valueObject.id = "setting-" + setting.id + "-value"
                    valueObject.type = setting.type
                    setting.handler.updateElement(valueObject)
                    valueObject.oninput = () => {
                        setting.handler.set(valueObject)

                        setting.handler.update()
                    }

                    settingObject.appendChild(valueObject)
                    document.getElementById("settings-list").appendChild(settingObject)
                })

                document.getElementById("export").onclick = () => {
                    var data = ""

                    for (var setting of settings) {
                        if (setting.export && localStorage.getItem(setting.id).toLowerCase() != "undefined" && localStorage.getItem(setting.id).toLowerCase().toLowerCase() != "null") {
                            data += setting.id + "=" + localStorage.getItem(setting.id) + "\n"
                        }
                    }

                    var element = document.createElement("a")
                    element.setAttribute("href", "data:text/plain," + encodeURIComponent(data))
                    element.setAttribute("download", "settings.txt")

                    element.style.display = "none"
                    document.body.appendChild(element)

                    element.click()

                    document.body.removeChild(element)
                }

                document.getElementById("import").onclick = () => {
                    document.getElementById("importFile").click()

                    document.getElementById("importFile").onchange = () => {
                        if (document.getElementById("importFile").files[0]) {
                            document.getElementById("importFile").files[0].text().then(text => {
                                var settings = text.split("\n")

                                for (var setting of settings) {
                                    if (setting.split("=").length != 2 || setting.split("=")[1].toLowerCase() == "undefined" || setting.split("=")[1].toLowerCase() == "null") {
                                        break
                                    }

                                    localStorage.setItem(setting.split("=")[0], setting.split("=")[1])

                                    if (document.getElementById("setting-" + setting.split("=")[0] + "-value").type == "checkbox") {
                                        if (setting.split("=")[1] == "true") {
                                            document.getElementById("setting-" + setting.split("=")[0] + "-value").checked = true
                                        } else {
                                            document.getElementById("setting-" + setting.split("=")[0] + "-value").checked = false
                                        }
                                    } else {
                                        document.getElementById("setting-" + setting.split("=")[0] + "-value").value = setting.split("=")[1]
                                    }
                                }

                                updateSettings()
                            })
                        }
                    }
                }
            }
        </script>
    </main>

    {global}
</body>

</html>